#!/usr/bin/env bash
# bin/compile <BUILD_DIR> <CACHE_DIR> <ENV_DIR>

set -e
set -o pipefail

# Append indentation to match Heroku style.
indent () {
	sed -u 's/^/       /'
}

echo "-----> Found package.lua"

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
BIN_DIR=$BUILD_DIR/bin
PATH=$BIN_DIR:$PATH

echo "-----> Fetching lit"

mkdir -p $BIN_DIR
cd $BIN_DIR
curl -L https://github.com/luvit/lit/raw/master/get-lit.sh | sh | indent
chmod +x $BIN_DIR/lit

if [ ! -f $ENV_DIR/SKIP_LUVIT ]; then
	echo "-----> Building luvit"

	lit make lit://luvit/luvit | indent
	chmod +x $BIN_DIR/luvit

	if [ ! -f $BIN_DIR/luvit ]; then
		echo "Luvit binary not found after build step"
		exit 1
	fi

	echo "Luvit built to $BIN_DIR/luvit" | indent
else
	echo "-----> SKIP_LUVIT env var found; skipping luvit build step"
fi

echo "-----> Installing deps"

cd $BUILD_DIR
lit install | indent

if [ -f $ENV_DIR/LIT_MAKE ]; then
	echo "-----> Running lit make"
	cd $BUILD_DIR
	lit make | indent
else
	echo "-----> LIT_MAKE env var not found; skipping lit make step"
fi
